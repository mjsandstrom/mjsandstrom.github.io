<html>
    <head>
        <title>KBank Microsite</title>
        

        <script type="text/javascript">
            async function getConsentCodeName(){
                let consentJson;
                const res = await fetch("https://kbankweb20231004140405.azurewebsites.net/consent/marketing/");

                consentJson = await res.json();

                return JSON.stringify(consentJson).replace(/"+/g, '');
            }
            
            (function (w, d, s, e, n) {
                w.XperienceTrackerName = n;
                w[n] = w[n] || function () {
                    (w[n].q = w[n].q || []).push(arguments);
                };
                var scriptElement = d.createElement(s);
                var scriptSection = d.getElementsByTagName(s)[0];
                scriptElement.async = 1;
                scriptElement.src = e.replace(/\/+$/, '') + '/Kentico.Resource/CrossSiteTracking/Logger.js';
                scriptSection.parentNode.insertBefore(scriptElement, scriptSection);
                w[n]('init', { mainSiteUrl: e, document: d, window: w });
            })(window, document, 'script', 'https://kbankweb20231004140405.azurewebsites.net', 'kxt');

            // Disables all tracking by default
            kxt('consentdefault', {
                allow_tracking: false,
                allow_datainput: false
            });

            getConsentCodeName().then((consentName) => {
                // Retrieves and displays the consent text
                kxt('consentdata', {
                        codeName: consentName,
                        cultureCode: 'en-US',
                        callback: consentData => {
                            document.getElementById('lblConsentText').innerHTML = consentData.shortText;
                        }
                    });

                    // Enables tracking if the current contact has agreed with the consent
                    kxt('consentcontactstatus', {
                        codeName: consentName,
                        callback: consentStatus => {
                            if (consentStatus.isAgreed) {
                                kxt('updateconsent', {
                                    allow_tracking: true,
                                    allow_datainput: true
                                });
                            }
                        }
                    });

                // Logs a page visit activity (if tracking is enabled for the current contact)
                kxt('pagevisit');

                //Registers click event handlers for tracking functions
                const consentAgreeButton = document.getElementById("btnConsentAgree");
                consentAgreeButton.addEventListener("click", function () {
                    trackingConsentAgree(consentName);
                })
                const consentRevokeButton = document.getElementById("btnConsentRevoke");
                consentRevokeButton.addEventListener("click", function () {
                    trackingConsentRevoke(consentName);
                })
            });

            // Click handler that creates a consent agreement for the current contact
            function trackingConsentAgree(consentName) {
                kxt('consentagree', {
                    codeName: consentName,
                    callback: () => {
                        // Enables tracking for any subsequent logging scripts
                        kxt('updateconsent', {
                            allow_tracking: true,
                            allow_datainput: true
                        });
                    }
                });
            }

            // Click handler that revokes the tracking consent agreement for the current contact
            function trackingConsentRevoke(consentName) {
                kxt('consentrevoke', {
                    codeName: consentName,
                    callback: () => {
                        // Disables tracking for any subsequent logging scripts
                        kxt('updateconsent', {
                            allow_tracking: false,
                            allow_datainput: false
                        });
                    }
                });
            }

            function logDownload(){
                kxt('customactivity', {
                    type: 'filedownload',
                    value: window.location.pathname,
                    title: 'File downloaded - ' + this.getAttribute("alt")
                });
            }
            
        </script>

    </head>
    <body>
        <h2>Welcome to a KBank Microsite</h2>

        <a href="./promotion.pdf" alt="pdf with details about a promotion" onclick="logDownload()" download>Download our promotional PDF</a>

        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in tempus est. Maecenas eu urna id quam lacinia porta. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi quis massa efficitur, cursus nisi dictum, ullamcorper libero. Pellentesque a sodales tortor. Ut quis rhoncus justo, vel molestie quam. Fusce quis pretium mi. Suspendisse pretium ante quis massa ornare condimentum. In at tortor eros. Fusce vitae sem venenatis, mollis augue a, imperdiet sapien. Nullam at ultricies est. Sed elit lorem, blandit sed pharetra ullamcorper, elementum vitae elit. Etiam convallis risus non massa pharetra ultricies nec ac nibh. Ut elit felis, viverra sed nisi eu, interdum imperdiet risus.</p>
        <p>Nullam rhoncus facilisis urna id ultrices. In ut arcu ac nunc sodales luctus. Donec ut fermentum lacus. Integer vel tellus risus. Mauris sed porttitor dui. Nullam vitae ultricies nunc. Vestibulum eleifend ligula ac mi pretium luctus. Vestibulum quis ornare nisl.</p>
        <p>Sed eget ultricies lacus. In ac maximus neque, maximus scelerisque leo. Fusce vehicula tellus quis lacus luctus, in rutrum nulla dictum. In at suscipit nunc. Nunc id aliquam turpis, in efficitur lacus. Pellentesque sed erat non magna facilisis ultricies. Ut viverra id odio vel hendrerit. Praesent arcu urna, lacinia iaculis tellus non, sagittis pellentesque augue. Interdum et malesuada fames ac ante ipsum primis in faucibus. Fusce hendrerit nisl sit amet nibh luctus, quis finibus massa placerat. Nulla pulvinar magna vitae commodo euismod. Cras interdum nisl at risus auctor faucibus. Praesent in libero volutpat, posuere nibh nec, viverra leo. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas.</p>

        <label id="lblConsentText">I consent to tracking</label>
        <button id="btnConsentAgree">Agree to be tracked</button>
        <button id="btnConsentRevoke">Revoke tracking consent</button>
    </body>
</html>